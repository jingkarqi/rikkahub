# PPIO Seedream 4.0 生图适配代码实现

## 概述

本文档提供PPIO Seedream 4.0图像生成功能的具体代码实现，包含所有需要修改和新增的代码文件。

## 1. ProviderSetting扩展

### 文件: `ai/src/main/java/me/rerere/ai/provider/ProviderSetting.kt`

**修改内容**: 在ProviderSetting密封类中添加PPIO配置类

```kotlin
// 在ProviderSetting密封类中添加PPIO配置类
@Serializable
@SerialName("ppio")
data class PPIO(
    override var id: Uuid = Uuid.random(),
    override var enabled: Boolean = true,
    override var name: String = "PPIO",
    override var models: List<Model> = emptyList(),
    override var proxy: ProviderProxy = ProviderProxy.None,
    override val balanceOption: BalanceOption = BalanceOption(),
    @Transient override val builtIn: Boolean = false,
    @Transient override val description: @Composable (() -> Unit) = {},
    @Transient override val shortDescription: @Composable (() -> Unit) = {},
    var apiKey: String = "",
    var baseUrl: String = "https://api.ppinfra.com/v3",
) : ProviderSetting() {
    override fun addModel(model: Model): ProviderSetting = copy(models = models + model)
    
    override fun editModel(model: Model): ProviderSetting = copy(models = models.map { 
        if (it.id == model.id) model.copy() else it 
    })
    
    override fun delModel(model: Model): ProviderSetting = copy(models = models.filter { 
        it.id != model.id 
    })
    
    override fun moveMove(from: Int, to: Int): ProviderSetting = copy(
        models = models.toMutableList().apply {
            val model = removeAt(from)
            add(to, model)
        }
    )
    
    override fun copyProvider(
        id: Uuid, enabled: Boolean, name: String, models: List<Model>,
        proxy: ProviderProxy, balanceOption: BalanceOption, builtIn: Boolean,
        description: @Composable (() -> Unit), shortDescription: @Composable (() -> Unit),
    ): ProviderSetting = this.copy(
        id = id, enabled = enabled, name = name, models = models,
        proxy = proxy, balanceOption = balanceOption, builtIn = builtIn,
        description = description, shortDescription = shortDescription
    )
}

// 在companion object的Types列表中添加PPIO
companion object {
    val Types by lazy {
        listOf(
            OpenAI::class,
            Google::class,
            Claude::class,
            PPIO::class,  // 新增
        )
    }
}
```

## 2. PPIO提供商实现

### 文件: `ai/src/main/java/me/rerere/ai/provider/providers/PPIOProvider.kt`

**新建文件**: 实现PPIO提供商

```kotlin
package me.rerere.ai.provider.providers

import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.withContext
import kotlinx.serialization.json.buildJsonObject
import kotlinx.serialization.json.contentOrNull
import kotlinx.serialization.json.jsonArray
import kotlinx.serialization.json.jsonObject
import kotlinx.serialization.json.jsonPrimitive
import kotlinx.serialization.json.put
import me.rerere.ai.provider.ImageGenerationParams
import me.rerere.ai.provider.Model
import me.rerere.ai.provider.Provider
import me.rerere.ai.provider.ProviderSetting
import me.rerere.ai.provider.TextGenerationParams
import me.rerere.ai.ui.ImageAspectRatio
import me.rerere.ai.ui.ImageGenerationItem
import me.rerere.ai.ui.ImageGenerationResult
import me.rerere.ai.ui.MessageChunk
import me.rerere.ai.ui.UIMessage
import me.rerere.ai.util.KeyRoulette
import me.rerere.ai.util.configureClientWithProxy
import me.rerere.ai.util.json
import me.rerere.ai.util.mergeCustomBody
import me.rerere.ai.util.toHeaders
import me.rerere.common.http.await
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.OkHttpClient
import okhttp3.Request
import okhttp3.RequestBody.Companion.toRequestBody
import java.math.BigDecimal

class PPIOProvider(
    private val client: OkHttpClient
) : Provider<ProviderSetting.PPIO> {
    private val keyRoulette = KeyRoulette.default()

    override suspend fun listModels(providerSetting: ProviderSetting.PPIO): List<Model> = 
        withContext(Dispatchers.IO) {
            // PPIO Seedream 4.0模型列表
            listOf(
                Model(
                    modelId = "seedream-4.0",
                    displayName = "Seedream 4.0",
                    type = me.rerere.ai.provider.ModelType.IMAGE,
                    inputModalities = setOf(me.rerere.ai.provider.Modality.TEXT),
                    outputModalities = setOf(me.rerere.ai.provider.Modality.IMAGE),
                    abilities = emptySet()
                )
            )
        }

    override suspend fun getBalance(providerSetting: ProviderSetting.PPIO): String = 
        "PPIO余额查询功能待实现"

    override suspend fun generateText(
        providerSetting: ProviderSetting.PPIO,
        messages: List<UIMessage>,
        params: TextGenerationParams
    ): MessageChunk {
        throw UnsupportedOperationException("PPIO提供商目前仅支持图像生成")
    }

    override suspend fun streamText(
        providerSetting: ProviderSetting.PPIO,
        messages: List<UIMessage>,
        params: TextGenerationParams
    ): Flow<MessageChunk> {
        throw UnsupportedOperationException("PPIO提供商目前仅支持图像生成")
    }

    override suspend fun generateImage(
        providerSetting: ProviderSetting,
        params: ImageGenerationParams
    ): ImageGenerationResult = withContext(Dispatchers.IO) {
        require(providerSetting is ProviderSetting.PPIO) {
            "Expected PPIO provider setting"
        }

        val key = keyRoulette.next(providerSetting.apiKey)

        // 映射宽高比到PPIO尺寸
        val size = when (params.aspectRatio) {
            ImageAspectRatio.SQUARE -> "2048x2048"    // 1:1
            ImageAspectRatio.LANDSCAPE -> "2560x1440" // 16:9
            ImageAspectRatio.PORTRAIT -> "1440x2560"  // 9:16
        }

        // 构建请求体
        val requestBody = json.encodeToString(
            buildJsonObject {
                put("prompt", params.prompt)
                put("size", size)
                put("sequential_image_generation", "disabled")  // 禁用批量生成，仅生成单张
                put("max_images", params.numOfImages.coerceIn(1, 15))
                put("watermark", false)  // 不添加水印
            }.mergeCustomBody(params.customBody)
        )

        // 构建HTTP请求
        val request = Request.Builder()
            .url("${providerSetting.baseUrl}/seedream-4.0")
            .headers(params.customHeaders.toHeaders())
            .addHeader("Authorization", "Bearer $key")
            .addHeader("Content-Type", "application/json")
            .post(requestBody.toRequestBody("application/json".toMediaType()))
            .build()

        // 执行请求
        val response = client.configureClientWithProxy(providerSetting.proxy).newCall(request).await()
        
        if (!response.isSuccessful) {
            val errorBody = response.body?.string() ?: "Unknown error"
            throw IllegalStateException("Failed to generate image: ${response.code} - $errorBody")
        }

        // 解析响应
        val bodyStr = response.body?.string() ?: ""
        val bodyJson = json.parseToJsonElement(bodyStr).jsonObject
        val images = bodyJson["images"]?.jsonArray ?: error("No images in response")

        // 转换为ImageGenerationItem列表
        val items = images.map { imageJson ->
            val base64Data = imageJson.jsonPrimitive.content
            ImageGenerationItem(
                data = base64Data,
                mimeType = "image/png"
            )
        }

        ImageGenerationResult(items = items)
    }
}
```

## 3. ProviderManager注册

### 文件: `ai/src/main/java/me/rerere/ai/provider/ProviderManager.kt`

**修改内容**: 在getProviderByType方法中添加PPIO提供商支持

```kotlin
fun <T : ProviderSetting> getProviderByType(setting: T): Provider<T> {
    @Suppress("UNCHECKED_CAST")
    return when (setting) {
        is ProviderSetting.OpenAI -> getProvider("openai")
        is ProviderSetting.Google -> getProvider("google")
        is ProviderSetting.Claude -> getProvider("claude")
        is ProviderSetting.PPIO -> getProvider("ppio")  // 新增
    } as Provider<T>
}
```

## 4. 模型注册表配置

### 文件: `ai/src/main/java/me/rerere/ai/registry/ModelRegistry.kt`

**修改内容**: 在模型注册表中添加Seedream 4.0模型

```kotlin
// 在模型注册表中添加PPIO Seedream 4.0模型
private val builtInModels = listOf(
    // ... 现有模型
    
    // PPIO Seedream 4.0
    Model(
        modelId = "seedream-4.0",
        displayName = "Seedream 4.0",
        type = ModelType.IMAGE,
        inputModalities = setOf(Modality.TEXT),
        outputModalities = setOf(Modality.IMAGE),
        abilities = emptySet()
    )
)
```

## 5. 提供商模块配置

### 文件: `ai/src/main/java/me/rerere/ai/di/ProviderModule.kt`

**修改内容**: 在Koin依赖注入模块中添加PPIO提供商

```kotlin
// 在ProviderModule中添加PPIO提供商
single<Provider<ProviderSetting.PPIO>> {
    PPIOProvider(client = get())
}
```

## 6. 默认提供商配置

### 文件: `app/src/main/java/me/rerere/rikkahub/data/datastore/DefaultProviders.kt`

**修改内容**: 在默认提供商列表中添加PPIO配置

```kotlin
// 在默认提供商列表中添加PPIO
val defaultProviders = listOf(
    // ... 现有提供商
    
    // PPIO提供商
    ProviderSetting.PPIO(
        name = "PPIO",
        builtIn = true,
        description = { Text("PPIO Seedream 4.0图像生成服务") },
        shortDescription = { Text("PPIO图像生成") },
        models = listOf(
            Model(
                modelId = "seedream-4.0",
                displayName = "Seedream 4.0",
                type = ModelType.IMAGE,
                inputModalities = setOf(Modality.TEXT),
                outputModalities = setOf(Modality.IMAGE),
                abilities = emptySet()
            )
        )
    )
)
```

## 7. 字符串资源

### 文件: `app/src/main/res/values/strings.xml`

**添加内容**: 添加PPIO相关的字符串资源

```xml
<!-- PPIO提供商相关字符串 -->
<string name="setting_provider_page_ppio_provider">PPIO</string>
<string name="setting_provider_page_ppio_api_key">API密钥</string>
<string name="setting_provider_page_ppio_api_key_desc">在PPIO平台获取的API密钥</string>
<string name="setting_provider_page_ppio_base_url">基础URL</string>
<string name="setting_provider_page_ppio_base_url_desc">PPIO API的基础URL</string>
```

## 8. 提供商图标

### 文件: 在资源目录中添加PPIO图标

**位置**: `app/src/main/assets/icons/ppio-color.svg`

需要添加PPIO提供商的SVG图标文件，确保与现有提供商图标风格一致。

## 实施步骤

### 步骤1: 修改现有文件
1. 修改 `ProviderSetting.kt` - 添加PPIO配置类
2. 修改 `ProviderManager.kt` - 注册PPIO提供商
3. 修改 `ModelRegistry.kt` - 添加Seedream 4.0模型
4. 修改 `ProviderModule.kt` - 添加依赖注入
5. 修改 `DefaultProviders.kt` - 添加默认配置
6. 修改 `strings.xml` - 添加字符串资源

### 步骤2: 创建新文件
1. 创建 `PPIOProvider.kt` - 实现PPIO提供商逻辑
2. 添加PPIO图标文件

### 步骤3: 构建和测试
1. 构建项目确保没有编译错误
2. 在设置中添加PPIO提供商配置
3. 在图像生成页面测试PPIO功能

## 错误处理

PPIOProvider中实现了基本的错误处理:
- API密钥验证失败
- 网络连接问题
- 响应格式异常
- 参数验证错误

## 性能优化

- 使用协程进行异步操作
- 支持代理配置
- 合理的超时设置
- 内存使用优化

## 注意事项

1. **仅文本生图**: 当前实现专注于仅文本生图功能，不支持图像编辑
2. **单张生成**: 设置为`sequential_image_generation = "disabled"`，仅生成单张图像
3. **无水印**: 默认关闭水印功能
4. **分辨率映射**: 根据宽高比自动选择合适的分辨率

## 测试验证

完成代码实现后，需要验证以下功能:
- [ ] PPIO提供商在设置页面可见
- [ ] Seedream 4.0模型在模型选择器中可见
- [ ] 能够成功生成图像
- [ ] 生成的图像能够正确保存和显示
- [ ] 错误情况得到适当处理
- [ ] 与现有UI组件完全兼容

此代码实现提供了完整的PPIO Seedream 4.0集成方案，确保与RikkaHub现有架构无缝对接。