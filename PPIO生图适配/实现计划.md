# PPIO Seedream 4.0 生图适配实现计划

## 概述

本文档详细规划了PPIO Seedream 4.0图像生成功能的适配实现方案，确保与RikkaHub现有架构无缝集成。

## 架构适配方案

### 1. 提供商配置类扩展

**文件**: `ai/src/main/java/me/rerere/ai/provider/ProviderSetting.kt`

**需要添加的PPIO配置类**:
```kotlin
@Serializable
@SerialName("ppio")
data class PPIO(
    override var id: Uuid = Uuid.random(),
    override var enabled: Boolean = true,
    override var name: String = "PPIO",
    override var models: List<Model> = emptyList(),
    override var proxy: ProviderProxy = ProviderProxy.None,
    override val balanceOption: BalanceOption = BalanceOption(),
    @Transient override val builtIn: Boolean = false,
    @Transient override val description: @Composable (() -> Unit) = {},
    @Transient override val shortDescription: @Composable (() -> Unit) = {},
    var apiKey: String = "",
    var baseUrl: String = "https://api.ppinfra.com/v3",
) : ProviderSetting() {
    // 实现标准的ProviderSetting方法
    override fun addModel(model: Model): ProviderSetting = copy(models = models + model)
    override fun editModel(model: Model): ProviderSetting = copy(models = models.map { if (it.id == model.id) model.copy() else it })
    override fun delModel(model: Model): ProviderSetting = copy(models = models.filter { it.id != model.id })
    override fun moveMove(from: Int, to: Int): ProviderSetting = copy(models = models.toMutableList().apply {
        val model = removeAt(from)
        add(to, model)
    })
    
    override fun copyProvider(
        id: Uuid, enabled: Boolean, name: String, models: List<Model>,
        proxy: ProviderProxy, balanceOption: BalanceOption, builtIn: Boolean,
        description: @Composable (() -> Unit), shortDescription: @Composable (() -> Unit),
    ): ProviderSetting = this.copy(
        id = id, enabled = enabled, name = name, models = models,
        proxy = proxy, balanceOption = balanceOption, builtIn = builtIn,
        description = description, shortDescription = shortDescription
    )
}
```

### 2. PPIO提供商实现

**文件**: `ai/src/main/java/me/rerere/ai/provider/providers/PPIOProvider.kt`

**核心功能**:
- 实现 `Provider<ProviderSetting.PPIO>` 接口
- 专注于仅文本生图功能
- 处理PPIO API参数映射
- 错误处理和响应解析

### 3. 参数映射策略

**PPIO API参数与RikkaHub参数的映射**:

| RikkaHub参数 | PPIO API参数 | 映射逻辑 |
|-------------|-------------|----------|
| `prompt` | `prompt` | 直接传递 |
| `numOfImages` | `max_images` | 限制在1-15范围内 |
| `aspectRatio` | `size` | 映射到对应的分辨率 |
| - | `sequential_image_generation` | 设置为"disabled"（仅生成单张） |
| - | `watermark` | 设置为false（无水印） |

**宽高比映射表**:
```kotlin
when (aspectRatio) {
    ImageAspectRatio.SQUARE -> "2048x2048"    // 1:1
    ImageAspectRatio.LANDSCAPE -> "2560x1440" // 16:9  
    ImageAspectRatio.PORTRAIT -> "1440x2560"  // 9:16
}
```

### 4. 模型配置

**Seedream 4.0模型定义**:
```kotlin
Model(
    modelId = "seedream-4.0",
    displayName = "Seedream 4.0",
    type = ModelType.IMAGE,
    inputModalities = setOf(Modality.TEXT),
    outputModalities = setOf(Modality.IMAGE),
    abilities = emptySet()
)
```

### 5. 提供商管理器注册

**文件**: `ai/src/main/java/me/rerere/ai/provider/ProviderManager.kt`

**需要添加**:
```kotlin
when (setting) {
    is ProviderSetting.OpenAI -> getProvider("openai")
    is ProviderSetting.Google -> getProvider("google") 
    is ProviderSetting.Claude -> getProvider("claude")
    is ProviderSetting.PPIO -> getProvider("ppio")  // 新增
}
```

### 6. API调用实现

**HTTP请求结构**:
```kotlin
val requestBody = json.encodeToString(
    buildJsonObject {
        put("prompt", params.prompt)
        put("size", sizeMapping)
        put("sequential_image_generation", "disabled")
        put("max_images", params.numOfImages.coerceIn(1, 15))
        put("watermark", false)
    }
)

val request = Request.Builder()
    .url("${providerSetting.baseUrl}/seedream-4.0")
    .addHeader("Authorization", "Bearer ${providerSetting.apiKey}")
    .addHeader("Content-Type", "application/json")
    .post(requestBody.toRequestBody("application/json".toMediaType()))
    .build()
```

### 7. 响应处理

**PPIO响应格式**:
```json
{
  "images": [
    "base64_encoded_image_data"
  ]
}
```

**响应解析**:
```kotlin
val bodyJson = json.parseToJsonElement(bodyStr).jsonObject
val images = bodyJson["images"]?.jsonArray ?: error("No images in response")

val items = images.map { imageJson ->
    val base64Data = imageJson.jsonPrimitive.content
    ImageGenerationItem(
        data = base64Data,
        mimeType = "image/png"
    )
}
```

## 实施步骤

### 阶段1: 核心提供商实现
1. 扩展ProviderSetting添加PPIO配置类
2. 创建PPIOProvider实现类
3. 在ProviderManager中注册PPIO提供商

### 阶段2: 模型配置
1. 定义Seedream 4.0模型配置
2. 确保模型选择器能够识别PPIO提供商

### 阶段3: 集成测试
1. 测试图像生成功能
2. 验证错误处理机制
3. 确保UI组件正常工作

## 技术考量

### 错误处理
- API密钥验证失败
- 网络连接问题
- 参数验证错误
- 响应格式异常

### 性能优化
- 支持代理配置
- 请求超时处理
- 内存使用优化

### 用户体验
- 与现有UI组件保持一致
- 适当的加载状态显示
- 清晰的错误信息提示

## 文件清单

需要创建/修改的文件:
- `ai/src/main/java/me/rerere/ai/provider/ProviderSetting.kt` (修改)
- `ai/src/main/java/me/rerere/ai/provider/providers/PPIOProvider.kt` (新建)
- `ai/src/main/java/me/rerere/ai/provider/ProviderManager.kt` (修改)
- `ai/src/main/java/me/rerere/ai/registry/ModelRegistry.kt` (修改)

## 验收标准

1. ✅ 能够在模型选择器中看到PPIO提供商和Seedream 4.0模型
2. ✅ 能够使用PPIO提供商生成图像
3. ✅ 生成的图像能够正确保存和显示
4. ✅ 错误情况能够得到适当处理
5. ✅ 与现有图像生成UI完全兼容

## 后续扩展

完成基础适配后，可以考虑:
- 支持PPIO的其他图像生成模型
- 实现图像编辑功能（参考图像输入）
- 添加余额查询功能
- 支持批量生成模式