# RikkaHub 图片生成界面UI实现研究

## 概述

本文档详细分析了RikkaHub项目中图片生成界面的UI实现架构、组件设计和交互流程，为PPIO生图适配提供参考。

## 核心架构

### 1. 页面结构

图片生成功能采用双标签页设计：

- **生成页面** (`ImageGenScreen`) - 图像生成界面
- **画廊页面** (`ImageGalleryScreen`) - 历史生成图像管理

### 2. 主要组件

#### 2.1 主页面 (`ImgGenPage.kt`)

**架构特点：**
- 使用 `HorizontalPager` 实现标签页切换
- 底部导航栏 (`BottomBar`) 提供页面切换功能
- 支持生成过程中取消操作

**关键实现：**
```kotlin
@Composable
fun ImageGenPage(
    modifier: Modifier = Modifier,
    vm: ImgGenVM = koinViewModel()
) {
    val pagerState = rememberPagerState { 2 }
    // 双标签页：生成页面(0)和画廊页面(1)
}
```

#### 2.2 视图模型 (`ImgGenVM.kt`)

**状态管理：**
- `prompt`: 用户输入的提示词
- `numberOfImages`: 生成图片数量 (1-4)
- `aspectRatio`: 图片宽高比 (方形、横屏、竖屏)
- `isGenerating`: 生成状态标识
- `currentGeneratedImages`: 当前生成的图片列表

**核心方法：**
- `generateImage()`: 调用AI提供商生成图像
- `cancelGeneration()`: 取消生成过程
- `deleteImage()`: 删除历史图像

### 3. 生成页面详细设计

#### 3.1 输入区域 (`InputBar`)

**组件构成：**
- 设置按钮 (`Settings2` 图标)
- 提示词输入框 (`OutlinedTextField`)
- 生成/取消按钮 (动态切换)

**交互逻辑：**
- 生成时显示圆形进度条
- 非生成时显示发送图标
- 点击设置按钮打开底部表单

#### 3.2 图片预览区域

**显示逻辑：**
- 最多显示2张当前生成的图片
- 使用 `AsyncImage` 加载本地文件
- 点击图片打开预览对话框

#### 3.3 设置底部表单 (`SettingsBottomSheet`)

**配置选项：**
- **模型选择** (`ModelSelector`): 选择图像生成模型
- **生成数量** (`OutlinedNumberInput`): 1-4张图片
- **宽高比** (`FilterChip`): 方形、横屏、竖屏

### 4. 画廊页面详细设计

#### 4.1 网格布局

**布局特点：**
- 2列网格 (`GridCells.Fixed(2)`)
- 支持下拉刷新 (`PullToRefreshBox`)
- 分页加载历史数据

#### 4.2 图片卡片

**卡片结构：**
- 图片预览 (点击打开大图预览)
- 模型名称标签
- 提示词摘要 (前20字符)
- 操作按钮行:
  - **复制提示词** (`Copy` 图标)
  - **保存图片** (`Save` 图标) 
  - **删除图片** (`Trash2` 图标)

### 5. 关键UI组件

#### 5.1 模型选择器 (`ModelSelector`)

**功能特性：**
- 支持按类型筛选 (IMAGE类型)
- 收藏模型功能
- 搜索过滤
- 提供商分组显示

**使用方式：**
```kotlin
ModelSelector(
    modelId = settings.imageGenerationModelId,
    providers = settings.providers,
    type = ModelType.IMAGE,
    onSelect = { model -> /* 更新设置 */ }
)
```

#### 5.2 图片预览对话框 (`ImagePreviewDialog`)

**功能特性：**
- 支持多图片切换 (`ImagePager`)
- 缩放查看功能
- 下载保存按钮
- 全屏模态对话框

#### 5.3 宽高比枚举 (`ImageAspectRatio`)

**支持比例：**
```kotlin
enum class ImageAspectRatio {
    SQUARE,      // 方形 (1:1)
    LANDSCAPE,   // 横屏 (16:9) 
    PORTRAIT     // 竖屏 (9:16)
}
```

### 6. 数据流架构

#### 6.1 状态管理流程

```
用户输入 → ViewModel状态更新 → UI重新组合
     ↓
生成请求 → Provider调用 → 结果处理
     ↓
图片保存 → 数据库存储 → 状态更新
```

#### 6.2 图像生成流程

1. 用户输入提示词和配置
2. 调用选定的AI提供商API
3. 接收base64编码的图像数据
4. 解码并保存到本地存储
5. 更新数据库记录
6. 刷新UI显示

### 7. 技术实现细节

#### 7.1 图像处理

**存储策略：**
- 使用应用专属目录存储图像
- 文件名格式: `{timestamp}_{modelName}_{index}.png`
- 数据库记录相对路径

**工具函数：**
- `createImageFileFromBase64()`: base64转文件
- `saveMessageImage()`: 保存到相册

#### 7.2 错误处理

**异常捕获：**
- 生成过程中的取消异常
- 网络请求失败
- 文件保存错误
- 数据库操作异常

**用户反馈：**
- Toast消息提示
- 错误状态重置

### 8. PPIO适配建议

基于当前架构，PPIO生图适配需要考虑：

1. **提供商集成**: 实现PPIO的Provider类，遵循现有的Provider接口
2. **参数映射**: 将现有参数映射到PPIO API要求
3. **错误处理**: 适配PPIO特定的错误码和消息
4. **UI一致性**: 保持与现有UI组件的视觉和交互一致性

### 9. 关键文件路径

- 主页面: `app/src/main/java/me/rerere/rikkahub/ui/pages/imggen/ImgGenPage.kt`
- 视图模型: `app/src/main/java/me/rerere/rikkahub/ui/pages/imggen/ImgGenVM.kt`
- 模型选择器: `app/src/main/java/me/rerere/rikkahub/ui/components/ai/ModelList.kt`
- 图片预览: `app/src/main/java/me/rerere/rikkahub/ui/components/ui/ImagePreviewDialog.kt`
- 图像工具: `app/src/main/java/me/rerere/rikkahub/utils/ImageUtils.kt`

## 总结

RikkaHub的图片生成界面采用了现代化的Jetpack Compose架构，具有良好的模块化和可扩展性。UI设计遵循Material Design 3规范，用户体验流畅。对于PPIO适配，主要工作集中在提供商接口的实现和参数映射上，现有UI框架可以很好地复用。